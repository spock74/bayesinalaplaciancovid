---
title: "Análise Bayesiana para Inferência Causal na COVID-19"
author: "José Elvano Moraes"
date: "4/1/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Análise Bayesiana para Inferência Causal na COVID-19

*Dataset* = https://dados.gov.br/dataset/bd-srag-2019

--------

**SRAG 2019** - Banco de Dados de Síndrome Respiratória Aguda Grave
Vigilância de Síndrome Respiratória Aguda Grave (SRAG)
O Ministério da Saúde, por meio da Secretaria de Vigilância em Saúde (SVS), desenvolve a vigilância da Síndrome Respiratória Aguda Grave (SRAG) no Brasil, desde 2009, devido a pandemia de Influenza A(H1N1)pdm09. A partir disso, a vigilância de SRAG foi implantada na rede de vigilância de Influenza e outros vírus respiratórios, que anteriormente atuava apenas com a vigilância sentinela de Síndrome Gripal (SG).

Recentemente (2020), a vigilância da COVID-19, a infecção humana causada pelo novo Coronavírus, que vem causando uma pandemia, foi incorporada na rede de vigilância da Influenza e outros vírus respiratórios.

Esta página tem como finalidade disponibilizar o legado dos banco de dados (BD) epidemiológicos de SRAG, da rede de vigilância da Influenza e outros vírus respiratórios, desde o início da sua implantação (2009) até os dias atuais (2020), com a incorporação da vigilância da COVID-19.

Para mais informações, acessar:

Gripe/Influenza - https://saude.gov.br/saude-de-a-z/gripe

COVID-19 - https://coronavirus.saude.gov.br/

--------

# Nota
Este documento é ainda tão somente experimentação e análise exploratória em fase absolutamente incipiente. Por isso a falta de estrutura, gráficos não explicativos, *typos*, etc

-------

```{r libraries, echo=TRUE}
suppressPackageStartupMessages(expr = library(tidyverse))
suppressPackageStartupMessages(expr = library(bnlearn))
suppressPackageStartupMessages(expr = library(bnstruct))
suppressPackageStartupMessages(expr = library(readr))
suppressPackageStartupMessages(expr = library(Rgraphviz))
suppressPackageStartupMessages(expr = library(Rmpfr))
```

# Subconjunto de variáveis selecionadas das 154 originais

Subconjuntos destas variáves são ainda combinadss em diferentes versões de análise
```{r}
dados <- read_csv("x_to_be_factors.csv", 
    col_types = cols(
        FEBRE = col_factor(levels = c("1", "2", "9")), 
        TOSSE = col_factor(levels = c("1", "2", "9")), 
        GARGANTA = col_factor(levels = c("1", "2", "9")), 
        DISPNEIA = col_factor(levels = c("1", "2", "9")), 
        DESC_RESP = col_factor(levels = c("1", "2", "9")), 
        SATURACAO = col_factor(levels = c("1", "2", "9")), 
        DIARREIA = col_factor(levels = c("1", "2", "9")), 
        VOMITO = col_factor(levels = c("1", "2", "9")), 
        OUTRO_SIN = col_factor(levels = c("1", "2", "9")), 
        HOSPITAL = col_factor(levels = c("1", "2", "9")), 
        EVOLUCAO = col_factor(levels = c("1", "2", "3", "9")), 
        RENAL = col_factor(levels = c("1", "2", "9")), 
        DIABETES = col_factor(levels = c("1", "2", "9")), 
        OBESIDADE = col_factor(levels = c("1", "2", "9")), 
        CLASSI_OUT = col_character(), 
        PERD_OLFT = col_factor(levels = c("1", "2", "9")), 
        PERD_PALA = col_factor(levels = c("1", "2", "9")), 
        VACINA = col_factor(levels = c("1", "2", "9")), 
        CLASSI_FIN = col_factor(levels = c("1", "2", "3", "4", "5"))))

#View(dados)
```

# Grupamento clinico: Retirada a variável **hospital**
```{r echo=TRUE}
#reselecionar retira a variavel automatica X1
 xx <- select(dados,
            FEBRE,
            TOSSE,
            GARGANTA,
            DISPNEIA,
            DESC_RESP,
            SATURACAO,
            DIARREIA,
            VOMITO,
            OUTRO_SIN,
            #HOSPITAL,
            EVOLUCAO,
            RENAL,
            DIABETES,
            OBESIDADE,
            #CLASSI_OUT,
            PERD_OLFT,
            PERD_PALA,
            VACINA,
            CLASSI_FIN)
# dado não pode ser `tible` nas funções de *bnlearn*
x = as.data.frame(xx)
```

# Omitir linhas com NA´s
```{r}
# mmpc e mmhc não admitem NA
x_no_na <- na.omit(x)
```

```{r echo=TRUE}
# 1 influenza
# 2
# 3
# 4
# 5 COVID
srag_covid <- x_no_na %>% filter(CLASSI_FIN == 5)
srag_outras <- x_no_na %>% filter(CLASSI_FIN != 5)
```


# Inferência da estrutura da Rede Causal usando o Algoritmoritmo **mmpc** 
```{r echo=FALSE}
suppressWarnings(bn_mmpc <- mmpc(x_no_na))
suppressWarnings(bn_mmpc_outras <- mmpc(srag_outras))
suppressWarnings(bn_mmpc_covid <- mmpc(srag_covid))
```

Max-Min Parents and Children (**mmpc**): *a forward selection technique for neighbourhood detection based on the maximization of the minimum association measure observed with any subset of the nodes selected in the previous iterations (Tsamardinos et al. 2006). It learns the underlying structure of the Bayesian network (all the arcs are undirected, no attempt is made to detect their orientation)*. 
```{r}
graphviz.plot(bn_mmpc, shape = 'rectangle', main = "Algoritmo = mmpc. DATA  = Todas SRAG`s")
```



```{r}
graphviz.plot(bn_mmpc_covid, shape = 'rectangle', main = "Algoritmo = mmpc. DATA = COVID")
```



```{r}
graphviz.plot(bn_mmpc_outras, shape='rectangle', main = "Algoritmo = mmpc. DATA = Outras")
```



# Inferência da estrutura da Rede Causal usando o Algoritmoritmo **mmhc**
```{r pressure, echo=TRUE}
suppressWarnings(bn_mmhc <- mmhc(x_no_na))
suppressWarnings(bn_mmhc_outras <- mmhc(srag_outras))
suppressWarnings(bn_mmhc_covid <- mmhc(srag_covid))

graphviz.plot(bn_mmhc, shape = 'rectangle', main = "Data = Todas SRAG`s, Algoritmoritmo = mmhc")

graphviz.plot(bn_mmhc_outras, shape = 'rectangle', main = "Data = outras SRAG, Algoritmo = mmhc")

graphviz.plot(bn_mmhc_covid, shape = 'rectangle', main = "Data = COVID, Algoritmo = mmhc")
```

-----------

# Incremental Association (iamb): 

Based on the Incremental Association Markov blanket (IAMB) Algoritmorithm (Tsamardinos et al. 2003), which is based on a two-phase selection scheme (a forward selection followed by an attempt to remove false positives).

## Inferência da estrutura da Rede Causal usando o Algoritmoritmo **iamb**
```{r iamb, echo=TRUE}
suppressWarnings(bn_iamb <- iamb(x_no_na))
graphviz.plot(bn_iamb, shape = 'rectangle')
```

# Inferência da estrutura da Rede Causal usando o Algoritmoritmo **gs**
```{r gs, echo=TRUE}
suppressWarnings(bn_gs <- gs(x_no_na))
graphviz.plot(bn_gs, shape = 'rectangle')
```

# Inferência da estrutura da Rede Causal usando o Algoritmoritmo **hc**
```{r hc, echo=TRUE}
suppressWarnings(bn_hc <- hc(x_no_na))
suppressWarnings(bn_hc_outras <- hc(srag_outras))
suppressWarnings(bn_hc_covid <- hc(srag_covid))
graphviz.plot(bn_hc, shape = 'rectangle', main = "Algoritmo = hc DATA = Todas SRAG`s")
graphviz.plot(bn_hc_covid, shape = 'rectangle', main = "Algoritmo = hc DATA = COVID")
graphviz.plot(bn_hc_outras, shape = 'rectangle', main = "Algoritmo = hc DATA = OUTRAS")
```

# Ajustamento da estrutura do Algoritmoritmo *HC* com os dados
```{r fit, echo=FALSE}
fitted_hc = bn.fit(bn_hc, x_no_na)
fitted_hc_outras = bn.fit(bn_hc_outras, srag_outras)
fitted_hc_covid = bn.fit(bn_hc_covid, srag_covid)
```

## Descrição estatística da rede para a variável EVOLUCAO DATA = Todas SRAG`s
```{r echo=FALSE}
fitted_hc$EVOLUCAO
``` 

## Descrição estatística da rede para a variável EVOLUCAO DATA = COVID
```{r echo=FALSE}
fitted_hc_covid$EVOLUCAO
``` 


## Descrição estatística da rede para a variável EVOLUCAO DATA = OUTRAS
```{r echo=FALSE}
fitted_hc_outras$EVOLUCAO
``` 

---------


```{r echo=FALSE}
suppressWarnings(bn.fit.barchart(fitted_hc$EVOLUCAO, xlab = "hc ProbabilidadesTodas SRAG", ylab = "EVOLUCAO TODAS SRAG`s"))

suppressWarnings(bn.fit.barchart(fitted_hc_covid$EVOLUCAO, xlab = "hc Probabilidades COVID", ylab = "EVOLUCAO COVID"))

suppressWarnings(bn.fit.barchart(fitted_hc_outras$EVOLUCAO, xlab = "hc Probabilidades OUTRAS", ylab = "EVOLUCAO OUTRAS SRAGS"))
#graphviz.chart(fit_hc, type = "barchart", grid = TRUE, bar.col = "black",
#               strip.bg = "yellow")
```

--------------------

# Ajustamento da estrutura do Algoritmoritmo *MMHC* com os dados
## Descrição estatística da rede para a variável EVOLUCAO Algoritmo = mmhc
```{r echo=FALSE}
fitted_mmhc = bn.fit(bn_mmhc, x_no_na)
fitted_mmhc_outras = bn.fit(bn_mmhc_outras, srag_outras)
fitted_mmhc_covid = bn.fit(bn_mmhc_covid, srag_covid)


fitted_mmhc$EVOLUCAO

fitted_mmhc_covid$EVOLUCAO

fitted_mmhc_outras$EVOLUCAO

suppressWarnings(bn.fit.barchart(fitted_mmhc$EVOLUCAO, xlab = "mmhc ProbabilidadesTodas SRAG`s", ylab = "EVOLUCAO TODS SRAG`s"))

suppressWarnings(bn.fit.barchart(fitted_mmhc_covid$EVOLUCAO, xlab = "mmhc Probabilidades COVID", ylab = "EVOLUCAO COVID"))

suppressWarnings(bn.fit.barchart(fitted_mmhc_outras$EVOLUCAO, xlab = "mmhc Probabilidades OUTRAS", ylab = "EVOLUCAO OUTRAS SRAGS"))

```